<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Rules - AivulnHunter</title>
  <link rel="stylesheet" href="css/admin.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">üõ°Ô∏è AivulnHunter</div>
    <div class="nav-links">
      <a href="index.html">Dashboard</a>
      <a href="scan.html">Scan</a>
      <a href="agents.html">Agents</a>
      <a href="admin_rules.html" class="active">Rules</a>
      <a href="rl.html">RL Stats</a>
    </div>
    <button id="logoutBtn" class="btn-secondary" style="display:none;">Logout</button>
  </nav>

  <div class="container">
    <h1>üõ°Ô∏è Vulnerability Rules (Admin)</h1>
    <p>Manage security rules for AI system vulnerability scanning with full CRUD operations.</p>

    <!-- Login Required Message -->
    <div id="loginRequired" class="info-box">
      <h3>üîê Admin Login Required</h3>
      <p>Please login to manage vulnerability rules.</p>
      <button class="btn-primary" onclick="window.location.href='admin_login.html'">
        Go to Login
      </button>
    </div>

    <!-- Admin Panel (hidden until logged in) -->
    <div id="adminPanel" style="display:none;">
      <!-- Add Rule Button -->
      <div class="admin-actions">
        <button class="btn-primary" onclick="openAddModal()">
          ‚ûï Add New Rule
        </button>
      </div>

      <!-- Rules Table -->
      <div class="table-container">
        <table class="rules-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>OWASP</th>
              <th>Severity</th>
              <th>Priority</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="rulesTableBody">
            <tr>
              <td colspan="6" class="loading">Loading rules...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add/Edit Rule Modal -->
  <div id="ruleModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h3 id="modalTitle">Add New Rule</h3>
      <input type="hidden" id="ruleId">

      <div class="form-group">
        <label>Rule Name *</label>
        <input type="text" id="ruleName" placeholder="e.g., Prompt Injection Attack">
      </div>

      <div class="form-group">
        <label>OWASP ID</label>
        <input type="text" id="ruleOwasp" placeholder="e.g., LLM01, A03:2021">
      </div>

      <div class="form-group">
        <label>Severity</label>
        <select id="ruleSeverity">
          <option value="LOW">LOW</option>
          <option value="MEDIUM" selected>MEDIUM</option>
          <option value="HIGH">HIGH</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </div>

      <div class="form-group">
        <label>Priority (1-5)</label>
        <input type="number" id="rulePriority" min="1" max="5" value="3">
      </div>

      <div class="modal-actions">
        <button class="btn-primary" onclick="saveRule()">üíæ Save</button>
        <button class="btn-secondary" onclick="closeModal()">‚ùå Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast" style="display:none;"></div>

  <script>
    const API_URL = "http://127.0.0.1:8000";
    let editingRuleId = null;

    // DEBUG: Log role on page load
    console.log("DEBUG admin_rules.html: role on load:", localStorage.getItem("role"));

    // ========== 1Ô∏è‚É£ AUTH CHECK ==========
    function checkAuth() {
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");

      console.log("DEBUG admin_rules.html: checkAuth - token:", !!token, "role:", role);

      if (!token) {
        showLoginRequired();
        return false;
      }

      if (role !== "admin") {
        console.log("DEBUG admin_rules.html: Non-admin role, showing login required");
        showLoginRequired();
        return false;
      }

      return true;
    }

    function showLoginRequired() {
      document.getElementById("loginRequired").classList.add("active");
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";
    }

    function showAdminPanel() {
      document.getElementById("loginRequired").classList.remove("active");
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("adminPanel").classList.add("active");
      document.getElementById("logoutBtn").style.display = "block";
    }

    // ========== 2Ô∏è‚É£ FETCH RULES ==========
    async function fetchRules() {
      const token = localStorage.getItem("token");
      
      if (!token) {
        showLoginRequired();
        return [];
      }

      try {
        const res = await fetch(`${API_URL}/rules/`, {
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        if (res.status === 401) {
          // Token expired
          localStorage.removeItem("token");
          showLoginRequired();
          return [];
        }

        const data = await res.json();
        console.log("Rules loaded:", data);
        return data;
      } catch (err) {
        console.error("Failed to fetch rules:", err);
        showToast("Failed to load rules", "error");
        return [];
      }
    }

    // ========== 3Ô∏è‚É£ RENDER RULES TABLE ==========
    function renderRules(rules) {
      const tbody = document.getElementById("rulesTableBody");
      tbody.innerHTML = "";

      if (!rules || rules.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">No rules found. Add your first rule!</td>
          </tr>
        `;
        return;
      }

      rules.forEach(rule => {
        const row = `
          <tr>
            <td>${rule.id?.slice(0, 8) || rule.id}</td>
            <td>${rule.name}</td>
            <td>${rule.owasp || 'N/A'}</td>
            <td><span class="severity-badge severity-${rule.severity?.toLowerCase() || 'medium'}">${rule.severity}</span></td>
            <td>${rule.priority || 'N/A'}</td>
            <td class="actions">
              <button class="btn-icon" onclick='openEditModal(${JSON.stringify(rule).replace(/'/g, "\\'")})' title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon" onclick="deleteRule('${rule.id}')" title="Delete">üóëÔ∏è</button>
            </td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // ========== 4Ô∏è‚É£ LOAD RULES (Auto-refresh) ==========
    async function loadRules() {
      if (!checkAuth()) return;
      
      showAdminPanel();
      const rules = await fetchRules();
      renderRules(rules);
    }

    // ========== 5Ô∏è‚É£ MODAL CONTROL ==========
    function openAddModal() {
      editingRuleId = null;
      document.getElementById("modalTitle").textContent = "‚ûï Add New Rule";
      document.getElementById("ruleId").value = "";
      document.getElementById("ruleName").value = "";
      document.getElementById("ruleOwasp").value = "";
      document.getElementById("ruleSeverity").value = "MEDIUM";
      document.getElementById("rulePriority").value = "3";
      document.getElementById("ruleModal").style.display = "flex";
    }

    function openEditModal(rule) {
      editingRuleId = rule.id;
      document.getElementById("modalTitle").textContent = "‚úèÔ∏è Edit Rule";
      document.getElementById("ruleId").value = rule.id;
      document.getElementById("ruleName").value = rule.name;
      document.getElementById("ruleOwasp").value = rule.owasp || "";
      document.getElementById("ruleSeverity").value = rule.severity || "MEDIUM";
      document.getElementById("rulePriority").value = rule.priority || "3";
      document.getElementById("ruleModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("ruleModal").style.display = "none";
      editingRuleId = null;
    }

    // ========== 6Ô∏è‚É£ SAVE RULE (CREATE + UPDATE) ==========
    async function saveRule() {
      const token = localStorage.getItem("token");
      if (!token) {
        showToast("Please login first", "error");
        return;
      }

      const name = document.getElementById("ruleName").value.trim();
      if (!name) {
        showToast("Please enter a rule name", "error");
        return;
      }

      const rule = {
        name: name,
        owasp: document.getElementById("ruleOwasp").value.trim(),
        severity: document.getElementById("ruleSeverity").value,
        priority: parseInt(document.getElementById("rulePriority").value) || 3
      };

      const url = editingRuleId 
        ? `${API_URL}/rules/${editingRuleId}`
        : `${API_URL}/rules/`;

      const method = editingRuleId ? "PUT" : "POST";

      try {
        const res = await fetch(url, {
          method: method,
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(rule)
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || "Failed to save rule");
        }

        closeModal();
        await loadRules(); // Auto-refresh
        showToast(editingRuleId ? "Rule updated successfully" : "Rule created successfully", "success");
      } catch (err) {
        console.error("Save error:", err);
        showToast(err.message, "error");
      }
    }

    // ========== 7Ô∏è‚É£ DELETE RULE ==========
    async function deleteRule(id) {
      if (!confirm("Are you sure you want to delete this rule?")) {
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        showToast("Please login first", "error");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/rules/${id}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`
          }
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.detail || "Failed to delete rule");
        }

        await loadRules(); // Auto-refresh
        showToast("Rule deleted successfully", "success");
      } catch (err) {
        console.error("Delete error:", err);
        showToast(err.message, "error");
      }
    }

    // ========== 8Ô∏è‚É£ LOGOUT ==========
    function logout() {
      localStorage.removeItem("token");
      window.location.href = "admin_login.html";
    }

    // ========== 9Ô∏è‚É£ TOAST NOTIFICATIONS ==========
    function showToast(message, type = "info") {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.className = `toast toast-${type}`;
      toast.style.display = "block";

      setTimeout(() => {
        toast.style.display = "none";
      }, 3000);
    }

    // ========== üîß EVENT LISTENERS ==========
    document.getElementById("logoutBtn").addEventListener("click", logout);

    // Close modal on outside click
    document.getElementById("ruleModal").addEventListener("click", (e) => {
      if (e.target.id === "ruleModal") {
        closeModal();
      }
    });

    // Close modal on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeModal();
      }
    });

    // ========== üì± INITIALIZE ==========
    window.addEventListener('load', loadRules);
  </script>
</body>
</html>

