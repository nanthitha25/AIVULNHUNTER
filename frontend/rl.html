<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>RL Heatmap - AivulnHunter</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h2>üõ°Ô∏è AivulnHunter</h2>
  <nav>
    <a href="index.html">Home</a>
    <a href="scan.html">Scan</a>
    <a href="agents.html">Agents</a>
    <a href="rl.html" class="active">RL Heatmap</a>
    <a href="admin_login.html">Admin</a>
  </nav>
</header>

<div class="container">
  <h2>üìä Reinforcement Learning - Rule Priority Heatmap</h2>
  <p>Real-time visualization of rule effectiveness based on Q-learning scores.</p>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Rules</h3>
      <p id="totalRules">-</p>
    </div>
    <div class="stat-card">
      <h3>Avg Q-Score</h3>
      <p id="avgQScore">-</p>
    </div>
    <div class="stat-card">
      <h3>Max Q-Score</h3>
      <p id="maxQScore">-</p>
    </div>
    <div class="stat-card">
      <h3>High Priority Rules</h3>
      <p id="highPriority">-</p>
    </div>
  </div>
  
  <div class="chart-container">
    <h3>Rule Priority Matrix</h3>
    <canvas id="heatmapChart"></canvas>
  </div>
  
  <div class="rules-table-container">
    <h3>Rule Details</h3>
    <table id="rulesTable">
      <thead>
        <tr>
          <th>Rule</th>
          <th>OWASP</th>
          <th>Severity</th>
          <th>Q-Score</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody>
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>
  
  <div class="legend">
    <h4>Q-Score Color Legend</h4>
    <div class="legend-items">
      <span class="legend-item"><span class="color-box critical"></span> Q ‚â• 2.5 (Critical)</span>
      <span class="legend-item"><span class="color-box high"></span> Q ‚â• 1.5 (High)</span>
      <span class="legend-item"><span class="color-box medium"></span> Q ‚â• 0.5 (Medium)</span>
      <span class="legend-item"><span class="color-box low"></span> Q < 0.5 (Low)</span>
    </div>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.stat-card h3 {
  font-size: 14px;
  margin: 0 0 10px 0;
  opacity: 0.9;
}

.stat-card p {
  font-size: 28px;
  font-weight: bold;
  margin: 0;
}

.chart-container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin: 20px 0;
  overflow-x: auto;
}

#heatmapChart {
  min-width: 600px;
  min-height: 400px;
}

.rules-table-container {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  margin: 20px 0;
  overflow-x: auto;
}

#rulesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

#rulesTable th,
#rulesTable td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #eee;
}

#rulesTable th {
  background: #f5f5f5;
  font-weight: 600;
}

.severity-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.severity-CRITICAL { background: #e53935; color: white; }
.severity-HIGH { background: #fb8c00; color: white; }
.severity-MEDIUM { background: #fdd835; color: #333; }
.severity-LOW { background: #43a047; color: white; }

.priority-badge {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  border-radius: 50%;
  font-weight: bold;
  color: white;
}

.priority-1 { background: #e53935; }
.priority-2 { background: #fb8c00; }
.priority-3 { background: #fdd835; color: #333; }
.priority-4 { background: #43a047; }

.legend {
  background: #f5f5f5;
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
}

.legend h4 {
  margin: 0 0 10px 0;
}

.legend-items {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.color-box {
  width: 20px;
  height: 20px;
  border-radius: 4px;
}

.color-box.critical { background: #e53935; }
.color-box.high { background: #fb8c00; }
.color-box.medium { background: #fdd835; }
.color-box.low { background: #43a047; }
</style>

<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script>
// Check authentication
if (!localStorage.getItem("token")) {
  window.location.href = "admin_login.html";
}

// Initialize chart
let heatmapChart = null;

async function loadHeatmap() {
  try {
    const token = localStorage.getItem("token");
    
    // Fetch RL heatmap data
    const res = await fetch(`${API_BASE}/rl/heatmap`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    
    if (!res.ok) {
      throw new Error("Failed to fetch heatmap data");
    }
    
    const data = await res.json();
    
    // Update stats
    document.getElementById("totalRules").textContent = data.total_rules || 0;
    document.getElementById("avgQScore").textContent = (data.avg_q_score || 0).toFixed(2);
    document.getElementById("maxQScore").textContent = (data.max_q_score || 0).toFixed(2);
    
    // Count high priority rules (priority 1 or 2)
    const highPriorityCount = data.rules.filter(r => r.priority <= 2).length;
    document.getElementById("highPriority").textContent = highPriorityCount;
    
    // Prepare chart data
    const rules = data.rules || [];
    
    // Create matrix data for heatmap
    const chartData = rules.map((d, i) => ({
      x: i,
      y: d.severity,
      v: d.q_score,
      rule: d.rule,
      priority: d.priority
    }));
    
    // Render heatmap
    renderHeatmap(chartData, rules);
    
    // Render table
    renderTable(rules);
    
  } catch (err) {
    console.error("Error loading heatmap:", err);
    document.querySelector(".container").innerHTML = `
      <div class="error">
        <h3>Error Loading Heatmap</h3>
        <p>${err.message}</p>
      </div>
    `;
  }
}

function renderHeatmap(chartData, rules) {
  const ctx = document.getElementById("heatmapChart").getContext("2d");
  
  if (heatmapChart) {
    heatmapChart.destroy();
  }
  
  heatmapChart = new Chart(ctx, {
    type: 'matrix',
    data: {
      datasets: [{
        label: 'Rule Priority Heatmap',
        data: chartData,
        width: 50,
        height: 50,
        backgroundColor(ctx) {
          const value = ctx.raw?.v || 0;
          // Color based on Q-score
          if (value >= 2.5) {
            return 'rgba(229, 57, 53, 0.8)';  // Red - Critical
          } else if (value >= 1.5) {
            return 'rgba(251, 140, 0, 0.8)';  // Orange - High
          } else if (value >= 0.5) {
            return 'rgba(253, 216, 53, 0.8)'; // Yellow - Medium
          } else {
            return 'rgba(67, 160, 71, 0.8)';  // Green - Low
          }
        },
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            title: function(context) {
              const idx = context[0].dataIndex;
              return rules[idx]?.rule || `Rule ${idx + 1}`;
            },
            label: function(context) {
              const d = rules[context.dataIndex];
              return [
                `Q-Score: ${d.q_score}`,
                `Priority: ${d.priority}`,
                `Severity: ${d.severity}`
              ];
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          position: 'top',
          min: -0.5,
          max: rules.length - 0.5,
          ticks: {
            callback: function(value) {
              const idx = Math.floor(value);
              if (idx >= 0 && idx < rules.length) {
                return rules[idx]?.rule?.substring(0, 10) || '';
              }
              return '';
            },
            stepSize: 1,
            maxRotation: 45
          },
          title: {
            display: true,
            text: 'Rules'
          }
        },
        y: {
          type: 'linear',
          min: -0.5,
          max: 3.5,
          ticks: {
            callback: function(value) {
              const severities = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];
              if (value >= 0 && value < 4) {
                return severities[value];
              }
              return '';
            }
          },
          title: {
            display: true,
            text: 'Severity'
          }
        }
      }
    }
  });
}

function renderTable(rules) {
  const tbody = document.querySelector("#rulesTable tbody");
  tbody.innerHTML = '';
  
  rules.forEach(rule => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${rule.rule}</strong></td>
      <td>${rule.owasp || 'N/A'}</td>
      <td><span class="severity-badge severity-${rule.severity}">${rule.severity}</span></td>
      <td><strong>${rule.q_score.toFixed(2)}</strong></td>
      <td><span class="priority-badge priority-${rule.priority}">${rule.priority}</span></td>
    `;
    tbody.appendChild(row);
  });
}

// Auto-refresh every 10 seconds
setInterval(loadHeatmap, 10000);

// Initial load
loadHeatmap();
</script>

</body>
</html>

