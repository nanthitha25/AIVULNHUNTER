
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>RL Heatmap - AivulnHunter</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h2>üõ°Ô∏è AivulnHunter</h2>
  <nav>
    <a href="index.html">Home</a>
    <a href="scan.html">Scan</a>
    <a href="agents.html">Agents</a>
    <a href="rl.html" class="active">RL Heatmap</a>
    <a href="admin_login.html">Admin</a>
  </nav>
</header>

<div class="container">
  <h2>üìä Reinforcement Learning - Rule Priority Heatmap</h2>
  <p>Real-time visualization of rule effectiveness based on Q-learning scores.</p>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Rules</h3>
      <p id="totalRules">-</p>
    </div>
    <div class="stat-card">
      <h3>Avg Q-Score</h3>
      <p id="avgQScore">-</p>
    </div>
    <div class="stat-card">
      <h3>Max Q-Score</h3>
      <p id="maxQScore">-</p>
    </div>
    <div class="stat-card">
      <h3>High Priority Rules</h3>
      <p id="highPriority">-</p>
    </div>
  </div>
  
  <div class="chart-container">
    <h3>Rule Priority Matrix</h3>
    <canvas id="heatmapChart"></canvas>
  </div>
  
  <div class="rules-table-container">
    <h3>Rule Details</h3>
    <table id="rulesTable">
      <thead>
        <tr>
          <th>Rule</th>
          <th>OWASP</th>
          <th>Severity</th>
          <th>Q-Score</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody>
        <!-- Populated by JavaScript -->
      </tbody>
    </table>
  </div>
  
  <div class="legend">
    <h4>Q-Score Color Legend</h4>
    <div class="legend-items">
      <span class="legend-item"><span class="color-box critical"></span> Q ‚â• 2.5 (Critical)</span>
      <span class="legend-item"><span class="color-box high"></span> Q ‚â• 1.5 (High)</span>
      <span class="legend-item"><span class="color-box medium"></span> Q ‚â• 0.5 (Medium)</span>
      <span class="legend-item"><span class="color-box low"></span> Q < 0.5 (Low)</span>
    </div>
  </div>
  
  <div class="actions">
    <button onclick="resetRLScores()" class="btn-secondary">
      <i class="fa-solid fa-rotate-right"></i> Reset RL Scores
    </button>
  </div>
</div>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.stat-card h3 {
  font-size: 14px;
  margin: 0 0 10px 0;
  opacity: 0.9;
}

.stat-card p {
  font-size: 28px;
  font-weight: bold;
  margin: 0;
}

.chart-container {
  background: #1a1a2e;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  margin: 20px 0;
  overflow-x: auto;
}

#heatmapChart {
  min-width: 600px;
  min-height: 400px;
}

.rules-table-container {
  background: #1a1a2e;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  margin: 20px 0;
  overflow-x: auto;
}

#rulesTable {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

#rulesTable th,
#rulesTable td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #333;
}

#rulesTable th {
  background: #16213e;
  font-weight: 600;
  color: #e2e8f0;
}

#rulesTable td {
  color: #cbd5e1;
}

.severity-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.severity-CRITICAL { background: #dc2626; color: white; }
.severity-HIGH { background: #f97316; color: white; }
.severity-MEDIUM { background: #eab308; color: #333; }
.severity-LOW { background: #22c55e; color: white; }

.priority-badge {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  border-radius: 50%;
  font-weight: bold;
  color: white;
}

.priority-1 { background: #dc2626; }
.priority-2 { background: #f97316; }
.priority-3 { background: #eab308; color: #333; }
.priority-4 { background: #22c55e; }
.priority-5 { background: #3b82f6; }

.legend {
  background: #1a1a2e;
  padding: 15px;
  border-radius: 10px;
  margin: 20px 0;
}

.legend h4 {
  margin: 0 0 10px 0;
  color: #e2e8f0;
}

.legend-items {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #cbd5e1;
}

.color-box {
  width: 20px;
  height: 20px;
  border-radius: 4px;
}

.color-box.critical { background: #dc2626; }
.color-box.high { background: #f97316; }
.color-box.medium { background: #eab308; }
.color-box.low { background: #22c55e; }

.actions {
  margin: 20px 0;
  text-align: center;
}

.btn-secondary {
  background: #475569;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-secondary:hover {
  background: #64748b;
}

.q-score-bar {
  display: flex;
  align-items: center;
  gap: 10px;
}

.q-score-fill {
  height: 8px;
  border-radius: 4px;
  min-width: 100px;
  background: #334155;
  overflow: hidden;
}

.q-score-fill-inner {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease;
}
</style>

<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script>
// Check authentication
if (!localStorage.getItem("token")) {
  window.location.href = "admin_login.html";
}

// Initialize chart
let heatmapChart = null;

async function loadHeatmap() {
  try {
    const token = localStorage.getItem("token");
    
    // Fetch RL heatmap data from the real API
    const res = await fetch(`${API_BASE}/rl/heatmap`, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    
    if (!res.ok) {
      throw new Error("Failed to fetch heatmap data");
    }
    
    const data = await res.json();
    
    // Update stats
    document.getElementById("totalRules").textContent = data.total_rules || 0;
    document.getElementById("avgQScore").textContent = (data.avg_q_score || 0).toFixed(2);
    document.getElementById("maxQScore").textContent = (data.max_q_score || 0).toFixed(2);
    
    // Count high priority rules (priority 1 or 2)
    const rules = data.rules || [];
    const highPriorityCount = rules.filter(r => r.priority <= 2).length;
    document.getElementById("highPriority").textContent = highPriorityCount;
    
    // Render heatmap
    renderHeatmap(rules);
    
    // Render table
    renderTable(rules);
    
  } catch (err) {
    console.error("Error loading heatmap:", err);
    showError("Error Loading Heatmap", err.message);
  }
}

function renderHeatmap(rules) {
  const ctx = document.getElementById("heatmapChart").getContext("2d");
  
  if (heatmapChart) {
    heatmapChart.destroy();
  }
  
  // Sort rules by Q-score for better visualization
  const sortedRules = [...rules].sort((a, b) => b.q_score - a.q_score);
  
  const labels = sortedRules.map((d, i) => `${d.rule}`);
  const qScores = sortedRules.map(d => d.q_score);
  const priorities = sortedRules.map(d => d.priority);
  
  // Generate colors based on Q-score
  const backgroundColors = qScores.map(score => {
    if (score >= 2.5) return "rgba(220, 38, 38, 0.8)";   // Red - Critical
    if (score >= 1.5) return "rgba(249, 115, 22, 0.8)";  // Orange - High
    if (score >= 0.5) return "rgba(234, 179, 8, 0.8);";  // Yellow - Medium
    return "rgba(34, 197, 94, 0.8)";                     // Green - Low
  });
  
  const borderColors = qScores.map(score => {
    if (score >= 2.5) return "#dc2626";
    if (score >= 1.5) return "#f97316";
    if (score >= 0.5) return "#eab308";
    return "#22c55e";
  });
  
  heatmapChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Q-Score",
        data: qScores,
        backgroundColor: backgroundColors,
        borderColor: borderColors,
        borderWidth: 2,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: "y",
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const idx = context.dataIndex;
              const rule = sortedRules[idx];
              return [
                `Q-Score: ${rule.q_score.toFixed(2)}`,
                `Priority: ${rule.priority}`,
                `Severity: ${rule.severity}`,
                `OWASP: ${rule.owasp}`
              ];
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          max: 3,
          grid: {
            color: "rgba(255, 255, 255, 0.1)"
          },
          ticks: {
            color: "#94a3b8"
          },
          title: {
            display: true,
            text: "Q-Score",
            color: "#e2e8f0"
          }
        },
        y: {
          grid: {
            display: false
          },
          ticks: {
            color: "#e2e8f0",
            font: {
              size: 12
            }
          }
        }
      }
    }
  });
}

function renderTable(rules) {
  const tbody = document.querySelector("#rulesTable tbody");
  tbody.innerHTML = "";
  
  // Sort by Q-score
  const sortedRules = [...rules].sort((a, b) => b.q_score - a.q_score);
  
  sortedRules.forEach(rule => {
    const row = document.createElement("tr");
    
    // Determine severity class
    const severityClass = `severity-${rule.severity || "MEDIUM"}`;
    const priorityClass = `priority-${Math.min(rule.priority || 5, 5)}`;
    
    // Determine bar color
    let barColor = "#22c55e";
    if (rule.q_score >= 2.5) barColor = "#dc2626";
    else if (rule.q_score >= 1.5) barColor = "#f97316";
    else if (rule.q_score >= 0.5) barColor = "#eab308";
    
    row.innerHTML = `
      <td><strong>${rule.rule}</strong></td>
      <td>${rule.owasp || 'N/A'}</td>
      <td><span class="severity-badge ${severityClass}">${rule.severity || 'MEDIUM'}</span></td>
      <td>
        <div class="q-score-bar">
          <div class="q-score-fill">
            <div class="q-score-fill-inner" style="width: ${Math.min(rule.q_score * 33, 100)}%; background: ${barColor};"></div>
          </div>
          <strong>${rule.q_score.toFixed(2)}</strong>
        </div>
      </td>
      <td><span class="priority-badge ${priorityClass}">${rule.priority || 5}</span></td>
    `;
    tbody.appendChild(row);
  });
}

function showError(title, message) {
  document.querySelector(".container").innerHTML = `
    <div class="card ERROR" style="margin: 20px;">
      <h3>‚ùå ${title}</h3>
      <p>${message}</p>
    </div>
  `;
}

async function resetRLScores() {
  if (!confirm("Are you sure you want to reset all RL scores to default?")) return;
  
  try {
    const token = localStorage.getItem("token");
    
    const res = await fetch(`${API_BASE}/rl/reset`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    
    if (!res.ok) {
      throw new Error("Failed to reset scores");
    }
    
    // Reload heatmap
    loadHeatmap();
    
  } catch (err) {
    console.error("Error resetting RL scores:", err);
    alert("Failed to reset RL scores: " + err.message);
  }
}

// Auto-refresh every 10 seconds
setInterval(loadHeatmap, 10000);

// Initial load
loadHeatmap();
</script>

</body>
</html>

